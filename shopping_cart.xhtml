<!DOCTYPE html>
<html lang="en">

  <!-- View -->
  <headReplace metal:use-macro="/templates/header.xhtml/meta_head">
  </headReplace>

  <body>

    <navReplace metal:use-macro="./templates/nav.xhtml/nav_bar">
    </navReplace>
  
   
    <section class="divider_01" >
    <div class="container">
        <div class="row">
            <div class="ten columns">
                <h2>SHOPPING CART</h2>
            </div>
            <div class="two columns">
                <button id="startCart" class="add_button">START CART</button>
            </div>
        </div>
        
        <div class="row">

            <table class="menu_simple">
                <thead>
                <tr>
                    <th style="width: 10%"></th>
                    <th style="width: 15%">Product ID</th>
                    <th style="width: 50%">Product Name</th> 
                    <th style="width: 20%">Quantity</th>
                    <th style="width: 10%">Price</th> 
                </tr>
                    </thead>
              <tbody id='shoppingCart'>
                </tbody>
              
            </table>

        
        </div>
      
      
      <div class="row">
          <table class="menu_simple">
            <tr>
                <th style="width: 10%"></th>
                <th style="width: 15%"></th>
                <th style="width: 50%"></th> 
                <th style="width: 20%"></th>
                <th style="width: 10%">Total</th> 
            </tr>
            <td class="total_td"></td>
            <td class="total_td"></td>
            <td class="total_td"></td>
            <td class="total_td"></td>
              
            <!-- TOTAL MUST BE CHANGED DYANMICALLY-->
            <td id='total' class="total_td">$200.00</td>
          </table>
      </div> 

        
                <div class="row">
                    <div class="two columns">
                        <button id="cancelCart" class="remove_button">CANCEL</button>
                    </div>
                    
                    <div class="two columns">
                        <button class="add_button">CHECKOUT</button>
                    </div>
                </div>
        
    </div>
</section>
    

    <footerReplace metal:use-macro="./templates/footer.xhtml/footer_bar">
    </footerReplace>  
      
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="./js/main.js"></script>
      <script>
          /*<![CDATA[*/
          $(document).ready(function(){  
              
              
              
            Storage.prototype.setObject = function(key, value) {
                this.setItem(key, JSON.stringify(value));
            }

            Storage.prototype.getObject = function(key) {
                var value = this.getItem(key);
                return value && JSON.parse(value);
            }
         
            $("#startCart").click(function() {
                console.log("Start cart.");
                $.ajax({
                    url: "./shopping_cart.php",
                    type: "POST",
                    dataType: 'json',
                    data: {action: "startcart"},
                    success: function(returnedData) {
                        console.log("cart start response: ", returnedData);

                        // WEB STORAGE - SESSION STORAGE
                        //var sessionID = returnedData['s_id'];
                        sessionStorage.setObject('autosave', {items: []});
                        $("#startCart").css("display","none");

                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.log(jqXHR.statusText, textStatus);
                    }
                });
            });
      
            $("#cancelCart").click(function() {
                console.log("End cart.");
                $.ajax({
                    url: "./shopping_cart.php",
                    type: "POST",
                    dataType: 'json',
                    data: {action: "cancelcart"},
                    success: function(returnedData) {
                        console.log("cart cancel response: ", returnedData);


                        // SESSION STORAGE - CLEAR THE SESSION
                        sessionStorage.clear();
                        $("#startCart").css("display","block");
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.log(jqXHR.statusText, textStatus);
                    }
                });
                var shoppingCartList = $("#shoppingCart").html("");
            });  
              
              
            function loadShoppingCartItems() {

                var cartData = sessionStorage.getObject('autosave');

                // if nothing added leave function
                if(cartData == null) {
                    return;
                } else {
                    $("#startCart").css("display","none");
                }
                var cartDataItems = cartData['items'];
                var shoppingCartList = $("#shoppingCart");


                for(var i = 0; i < cartDataItems.length; i++) {
                    var item = cartDataItems[i];
                    // sku, qty, date
                    var sku = item['sku'];
                    var qty = item['qty'];
                    var date = item['date'];
                    var price = item['price'];
                    var title = item['title'];
                    var subtotal = parseFloat(Math.round((qty * price) * 100) / 100).toFixed(2);
                    var total = document.getElementById('total');

                    var item = "<tr data-item-sku='" + sku + "' data-item-qty='" + qty + "' data-item-date='"
                        + date + "'>" + title + " " + qty + " x $" + price + " = " + subtotal
                        + "<td><input class='' type='button' data-remove-button='remove' value='X'/></td><td>" + sku + "</td><td>" + title + "</td><td>" + qty + "</td><td>" + '$'+ subtotal + "</td></tr>";
                    shoppingCartList.append(item);


                }
                console.log('cart items array, added', cartDataItems);
            }
            loadShoppingCartItems();
              
              
            // remove items from the cart
            $("#shoppingCart").on("click", "input", function() {
                // https://api.jquery.com/closest/
                // WEB STORAGE REMOVE
                var thisInputSKU = this.parentNode.parentNode.getAttribute('data-item-sku');
                var thisInputQty = this.parentNode.parentNode.getAttribute('data-item-qty');
                var thisInputDate = this.parentNode.parentNode.getAttribute('data-item-date');

                var cartData = sessionStorage.getObject('autosave');
                if(cartData == null) {
                    return;
                }
                var cartDataItems = cartData['items'];
                for(var i = 0; i < cartDataItems.length; i++) {
                    var item = cartDataItems[i];
                    // get the item based on the sku, qty, and date
                    if(item['sku'] == thisInputSKU && item['date'] == thisInputDate) {
                        // remove from web storage
                        cartDataItems.splice(i, 1);

                    }
                }
                cartData['items'] = cartDataItems;
                console.log('cart data stuff', cartData);
                // clobber the old value
                sessionStorage.setObject('autosave', cartData);

                this.closest("tr").remove();

            });
              
       });
          /*]]>*/
      </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="en">

  <!-- View -->
  <headReplace metal:use-macro="/templates/header.xhtml/meta_head">
  </headReplace>

  <body>

    <navReplace metal:use-macro="./templates/nav.xhtml/nav_bar">
    </navReplace>
      
    <div class='container'>
    <section class="divider_02">   
            <div class="row">
                <div class="twelve columns">
                    <h2>RENTALS</h2>
                </div>
            </div>
    </section> 
        
        <div id="productslist">
        
        
        </div>
      
    </div>  
      
 
    <footerReplace metal:use-macro="./templates/footer.xhtml/footer_bar">
    </footerReplace> 
      
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="./js/main.js"></script>
      <script>
    $(document).ready(function() {
            function loadProducts() {
                $.ajax({
                    url: "php/productManager.php",
                    type: "GET",
                    dataType: 'html',
                    success: function(returnedData) {
                        //console.log("cart checkout response: ", returnedData);
                        $("#productslist").html(returnedData);
                        
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.log(jqXHR.statusText, textStatus);
                    }
                });
            }

            loadProducts();
        
            //WORK IN PROGRESS
            $('#productslist').on('click', 'input[data-sku-add]', function() {
                //console.log(this.getAttribute("data-sku-add"));

                // get the sku
                var sku = this.getAttribute("data-sku-add");
                var qty = $("input[data-sku-qty='" + sku + "']").val();
                var price = $("td[data-sku-price='" + sku + "']").text();
                var desc = $("td[data-sku-desc='" + sku + "']").text();
                var subtotal = parseFloat(Math.round((qty * price) * 100) / 100).toFixed(2);
                console.log(desc, "quantity", qty, "price", price);

                var shoppingCartList = $("#shoppingCart");


                // ALTERED FOR WEB STORAGE
                var aDate = new Date();
                var item = "<li data-item-sku='" + sku + "' data-item-qty='" + qty + "' data-item-date='"
                    + aDate.getTime() + "'>" + desc + " " + qty + " x $" + price + " = " + subtotal
                    + " <input type='button' data-remove-button='remove' value='X'/></li>";
                shoppingCartList.append(item);


                // SESSION STORAGE - SAVE SKU AND QTY AS AN OBJECT IN THE
                // ARRAY INSIDE OF THE AUTOSAVE OBJECT
                var cartData = sessionStorage.getObject('autosave');
                if(cartData == null) {
                    return;
                }
                var item = {'sku': sku, 'qty': qty, date: aDate.getTime(), 'desc': desc, 'price': price};
                cartData['items'].push(item);
                // clobber the old value
                sessionStorage.setObject('autosave', cartData);


            });
        
    });
    </script>
  </body>
    
    
</html>
